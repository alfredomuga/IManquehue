{
	"name": "ReservaActual",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "DetallerReserva",
						"type": "DatasetReference"
					},
					"name": "DetallePromesa"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ThPromesas",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "Promesa"
				},
				{
					"name": "lookup1"
				},
				{
					"name": "FechaCargaBI"
				}
			],
			"scriptLines": [
				"source(output(",
				"          id as integer,",
				"          fechaReserva as string,",
				"          totalLista as integer,",
				"          descuentoSubtotal as (valor as double, unidad as string),",
				"          totalVenta as double,",
				"          productos as (id as integer, nombre as string, tipo as string, precioLista as integer, descuento as (valor as double, unidad as string), precioVenta as double, proyecto as (id as integer, nombre as string), etapa as (id as integer, nombre as string), subAgrupacion as (id as integer, nombre as string))[],",
				"          cliente as (id as integer, identificadorPersonal as string, nombre as string, telefono as string, email as string)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     inferDriftedColumnTypes: true,",
				"     ignoreNoFilesFound: false,",
				"     documentForm: 'documentPerLine') ~> DetallePromesa",
				"DetallePromesa foldDown(unroll(productos),",
				"     mapColumn(",
				"          id = productos.id,",
				"          fechaReserva,",
				"          totalLista,",
				"          {descuentoSubtotal.valor} = descuentoSubtotal.valor,",
				"          {descuentoSubtotal.unidad} = descuentoSubtotal.unidad,",
				"          totalVenta,",
				"          {productos.id} = productos.id,",
				"          {productos.nombre} = productos.nombre,",
				"          {productos.tipo} = productos.tipo,",
				"          {productos.precioLista} = productos.precioLista,",
				"          {productos.descuento.valor} = productos.descuento.valor,",
				"          {productos.descuento.unidad} = productos.descuento.unidad,",
				"          precioVenta = productos.precioVenta,",
				"          {productos.proyecto.id} = productos.proyecto.id,",
				"          {productos.proyecto.nombre} = productos.proyecto.nombre,",
				"          {productos.etapa.id} = productos.etapa.id,",
				"          {productos.etapa.nombre} = productos.etapa.nombre,",
				"          {productos.subAgrupacion.id} = productos.subAgrupacion.id,",
				"          {productos.subAgrupacion.nombre} = productos.subAgrupacion.nombre,",
				"          {cliente.id} = cliente.id",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> Promesa",
				"Promesa lookup({productos.proyecto.id} == id_promesa,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> lookup1",
				"lookup1 derive(FechaCargaBI = currentTimestamp()) ~> FechaCargaBI",
				"FechaCargaBI sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          id as integer,",
				"          fechaPromesa as string,",
				"          totalLista as integer,",
				"          {descuentoSubtotal.valor} as double,",
				"          {descuentoSubtotal.unidad} as string,",
				"          totalVenta as integer,",
				"          {productos.id} as integer,",
				"          {productos.nombre} as string,",
				"          {productos.tipo} as string,",
				"          {productos.precioLista} as integer,",
				"          {productos.descuento.valor} as double,",
				"          {productos.descuento.unidad} as string,",
				"          {productos.precioVenta} as integer,",
				"          {productos.proyecto.id} as integer,",
				"          {productos.proyecto.nombre} as string,",
				"          {productos.etapa.id} as integer,",
				"          {productos.etapa.nombre} as string,",
				"          {productos.subAgrupacion.id} as integer,",
				"          {productos.subAgrupacion.nombre} as string,",
				"          {cliente.id} as integer,",
				"          {cliente.identificadorPersonal} as string,",
				"          {cliente.nombre} as string,",
				"          {cliente.telefono} as string,",
				"          {cliente.email} as string,",
				"          id_promesa as integer,",
				"          id_negocio as integer,",
				"          fecha_firma_comprador as string,",
				"          setFechaFirmaComprador as string,",
				"          FechaCargaBI as string",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     truncate:true,",
				"     format: 'table',",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          id = {productos.proyecto.id},",
				"          fechaPromesa,",
				"          totalLista,",
				"          {descuentoSubtotal.valor},",
				"          {descuentoSubtotal.unidad},",
				"          totalVenta,",
				"          {productos.id},",
				"          {productos.nombre},",
				"          {productos.tipo},",
				"          {productos.precioLista},",
				"          {productos.descuento.valor},",
				"          {productos.descuento.unidad},",
				"          {productos.precioVenta},",
				"          {productos.proyecto.id},",
				"          {productos.proyecto.nombre},",
				"          {productos.etapa.id},",
				"          {productos.etapa.nombre},",
				"          {productos.subAgrupacion.id},",
				"          {productos.subAgrupacion.nombre},",
				"          {cliente.id},",
				"          {cliente.identificadorPersonal},",
				"          {cliente.nombre},",
				"          {cliente.telefono},",
				"          {cliente.email},",
				"          id_promesa,",
				"          id_negocio,",
				"          fecha_firma_comprador,",
				"          setFechaFirmaComprador",
				"     )) ~> sink1"
			]
		}
	}
}